"use strict";var O=Object.defineProperty;var o=(s,t)=>O(s,"name",{value:t,configurable:!0});var j=require("child_process"),f=require("fs"),P=require("os"),_=require("path"),se=require("module"),re=typeof document!="undefined"?document.currentScript:null;const R=o(s=>Object.fromEntries(Object.entries(s).filter(([t,e])=>e!==void 0)),"removeUndefinedKeys");var y=o((s,t,e)=>new Promise((r,i)=>{var c=o(n=>{try{a(e.next(n))}catch(l){i(l)}},"fulfilled"),d=o(n=>{try{a(e.throw(n))}catch(l){i(l)}},"rejected"),a=o(n=>n.done?r(n.value):Promise.resolve(n.value).then(c,d),"step");a((e=e.apply(s,t)).next())}),"__async$1");const q="Content-Type",b="application/json",A="/v1/auth/universal-auth/login",L="/v3/secrets/raw",E=class E{constructor(t,e,r){this.apiUrl=t,this.clientId=e,this.clientSecret=r,this.token=void 0}getSecretsJson(t){return y(this,null,function*(){return(yield this.listSecrets(t)).reduce((i,c)=>(i[c.name]=c.value,i),{})})}getSecretsEnv(t){return y(this,null,function*(){return(yield this.listSecrets(t)).map(i=>`${i.name}=${JSON.stringify(i.value)}`).join(P.EOL)})}listSecrets(t){return y(this,null,function*(){const{projectId:e,environment:r,secretPath:i,tagSlugs:c}=t,a={method:"GET",headers:yield this.getAuthHeaders()},n=new URLSearchParams(R({workspaceId:e,environment:r,secretPath:i,tagSlugs:c,recursive:!0})).toString(),l=yield fetch(`${this.apiUrl}${L}?${n}`,a);if(!l.ok)throw new Error(`API error ${l.status}`);return(yield l.json()).secrets.map(u=>({name:u.secretKey,value:u.secretValue})).sort((u,g)=>u.name.localeCompare(g.name))})}login(){return y(this,null,function*(){const t={[q]:b},e={clientId:this.clientId,clientSecret:this.clientSecret},r={method:"POST",headers:t,body:JSON.stringify(e)},i=yield fetch(`${this.apiUrl}${A}`,r);if(!i.ok)throw new Error(`API error ${i.status}`);return(yield i.json()).accessToken})}getAuthHeaders(){return y(this,null,function*(){return this.token===void 0&&(this.token=yield this.login()),{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"}})}};o(E,"Infisical");let F=E;var J=require;const B=J("path"),$="\x1B[0m",H="\x1B[32m",K="\x1B[33m",G="\x1B[35m",M="\x1B[36m",V=o(s=>`${H}${s}${$}`,"green"),T=o(s=>`${K}${s}${$}`,"yellow"),W=o(s=>`${G}${s}${$}`,"magenta"),z=o(s=>`${M}${s}${$}`,"cyan"),D=o(s=>`'${s}'`,"quote"),I=class I{start(){this.info(""),this.info(W("=== Setting Up ==="))}runningNpmCommand(t){this.info(`Running command ${T(t)}`)}fileCreated(t){const e=this.formatPath(t);this.info(`${e} created`)}fileUpdated(t){const e=this.formatPath(t);this.warn(`${e} updated`)}fileUnchanged(t){const e=this.formatPath(t);this.info(`${e} unchanged`)}finish(){this.info("")}formatPath(t){const e=B.relative(process.cwd(),t).replace(/\\/g,"/"),r=e.startsWith("./")||e.startsWith("../")?"":"./";return z(D(r+e))}info(t){console.log(`onboard ${V("info")} ${t}`)}warn(t){console.log(`onboard ${T("warn")} ${t}`)}};o(I,"Logger");let N=I;const Y=o(()=>j.execSync("npm config get userconfig",{encoding:"utf8"}).trim(),"getNpmConfigFile"),U=o(s=>f.existsSync(s)?f.readFileSync(s,"utf-8"):null,"safeReadFileSync");var Q=o((s,t,e)=>new Promise((r,i)=>{var c=o(n=>{try{a(e.next(n))}catch(l){i(l)}},"fulfilled"),d=o(n=>{try{a(e.throw(n))}catch(l){i(l)}},"rejected"),a=o(n=>n.done?r(n.value):Promise.resolve(n.value).then(c,d),"step");a((e=e.apply(s,t)).next())}),"__async");const k=_.resolve(__dirname,".secret"),X=o(()=>f.existsSync(k)?f.readFileSync(k,"utf-8"):void 0,"readClientSecret"),Z=o(s=>f.writeFileSync(k,s),"writeClientSecret"),ee=["Usage:","  node index.js <INFISICAL_CLIENT_SECRET> - Set up the development environment"].join(P.EOL),te=o(()=>Q(void 0,null,function*(){var s;const t=(s=process.argv[2])!=null?s:X();if(t===void 0)return console.log(ee);const e=JSON.parse(f.readFileSync(_.resolve(__dirname,"config.json"),"utf-8")),r=new N,i=new F(e.secrets.apiUrl,e.secrets.clientId,t);if(r.start(),e.npm!==void 0){const{registry:c,scopes:d}=e.npm,a=c.split("//")[1],{projectId:n,environment:l,secretPath:w,tags:m}=e.npm.secret,u=m.join(","),g=yield i.getSecretsJson({projectId:n,environment:l,secretPath:w,tagSlugs:u}),h=Y(),v=U(h);r.runningNpmCommand(`npm config set "//${a}:_authToken" [Redacted]`),j.execSync(`npm config set "//${a}:_authToken" ${g.NPM_READ_TOKEN}`,{stdio:"inherit"});for(let p=0;p<d.length;p++)r.runningNpmCommand(`npm config set "${d[p]}:registry" ${c}`),j.execSync(`npm config set "${d[p]}:registry" ${c}`,{stdio:"inherit"});v===null?r.fileCreated(h):U(h)===v?r.fileUnchanged(h):r.fileUpdated(h)}if(e.packages!==void 0)for(let c=0;c<e.packages.length;c++){const d={},a=e.packages[c],n=_.resolve(__dirname,a.filePath),l=U(n);for(let u=0;u<a.secrets.length;u++){const{projectId:g,environment:h,secretPath:v,tags:p}=a.secrets[u],x=p.join(","),C=yield i.listSecrets({projectId:g,environment:h,secretPath:v,tagSlugs:x});for(let S=0;S<C.length;S++)d[C[S].name]=C[S].value}const m=Object.keys(d).sort().map(u=>`${u}=${JSON.stringify(d[u])}`).join(P.EOL);l===null?(f.writeFileSync(n,m),r.fileCreated(n)):m===l?r.fileUnchanged(n):(f.writeFileSync(n,m),r.fileUpdated(n))}Z(t),r.finish()}),"run");te();
